---
import { asset } from '../../utils/assets';

const bgImageUrl = asset('img/bg-dental.jpg');
---

<section class="contact section" id="contacto">
	<div class="contact-background" style={`background-image: url('${bgImageUrl}');`}></div>
	
	<div class="container">
		<div class="section-header text-center">
			<h2>¿TIENES ALGUNA DUDA? Contáctanos</h2>
			<p class="section-description">
				Te escuchamos y estudiamos tu caso para proponerte la opción que mejor encaje contigo, cuidando salud, función y estética.
			</p>
		</div>
		
		<div class="contact-form-wrapper">
			<form class="contact-form" id="contact-form">
				<div class="form-row">
					<div class="form-group">
						<input type="text" id="nombre" name="nombre" placeholder="Nombre*" required />
					</div>
					<div class="form-group">
						<input type="text" id="apellido" name="apellido" placeholder="Apellido*" required />
					</div>
				</div>
				
				<div class="form-row">
					<div class="form-group">
						<input type="email" id="email" name="email" placeholder="E-mail*" required />
					</div>
					<div class="form-group">
						<input type="tel" id="telefono" name="telefono" placeholder="Teléfono*" required />
					</div>
				</div>
				
				<div class="form-group">
					<textarea id="mensaje" name="mensaje" rows="5" placeholder="Mensaje..."></textarea>
				</div>
				
				<div class="form-footer">
					<div class="form-checkbox">
						<input type="checkbox" id="privacidad" name="privacidad" required />
						<label for="privacidad">
							Acepto la <a href="/politica-privacidad">política de privacidad</a>*
						</label>
					</div>
					<button type="submit" class="btn-submit">ENVIAR</button>
				</div>
				
				<div id="form-message" class="form-message" style="display: none;"></div>
				
				<div class="legal-info">
					<button type="button" class="legal-toggle" aria-expanded="false" aria-controls="legal-content">
						<span class="toggle-icon">▼</span> Información legal
					</button>
					<div class="legal-content" id="legal-content" hidden>
						<p><strong>Información legal</strong></p>
						<p><strong>Responsable:</strong> D. Juan José Iturralde Armendáriz</p>
						<p><strong>Finalidad:</strong> Responder a su consulta.</p>
						<p><strong>Legitimación:</strong> Consentimiento del interesado.</p>
						<p><strong>Destinatarios:</strong> Los datos quedarán almacenados en nuestro servidor, alojado en Arsys Internet S.L.U. No se comunicará a terceros.</p>
						<p><strong>Derechos:</strong> Acceso, rectificación, supresión, limitación, portabilidad y olvido de los datos.</p>
						<p><strong>Más información:</strong> <a href="/politica-privacidad">Política de privacidad</a></p>
					</div>
				</div>
			</form>
		</div>
	</div>
</section>


<style>
	.contact {
		background: white;
		position: relative;
		z-index: 10;
		width: 100%;
		overflow: hidden;
	}
	
	.contact-background {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background-size: cover;
		background-position: center;
		background-repeat: no-repeat;
		z-index: 0;
	}
	
	.contact-background::after {
		content: '';
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background: linear-gradient(
			to right,
			rgba(255, 255, 255, 0) 0%,
			rgba(255, 255, 255, 0) 20%,
			rgba(255, 255, 255, 0.5) 35%,
			rgba(255, 255, 255, 0.9) 50%,
			rgba(255, 255, 255, 0.98) 60%,
			rgba(255, 255, 255, 1) 70%
		);
	}
	
	.contact .container {
		position: relative;
		z-index: 1;
	}
	
	.contact .section-header {
		margin-bottom: 3rem;
	}
	
	.contact .section-header h2 {
		font-size: 38px;
		color: var(--c-ink);
		font-family: var(--ff-head);
		font-weight: 700;
		line-height: 1.2;
		padding-bottom: 1rem;
		border-bottom: 3px solid var(--c-ink);
		display: inline-block;
		text-transform: none;
	}
	
	.section-description {
		font-size: var(--fs-body);
		color: var(--c-gray-700);
		line-height: 1.6;
		margin-top: 1.5rem;
		max-width: 800px;
		margin-left: auto;
		margin-right: auto;
	}
	
	.contact-form-wrapper {
		display: flex;
		justify-content: flex-end;
		width: 100%;
	}
	
	.contact-form {
		width: 100%;
		max-width: 650px;
		background: white;
		padding: 2.5rem;
		border-radius: var(--rad);
		box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
	}
	
	.form-row {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 1rem;
		margin-bottom: 1rem;
	}
	
	.form-group {
		width: 100%;
	}
	
	.form-group input,
	.form-group textarea {
		width: 100%;
		padding: 0.85rem 1rem;
		border: 1px solid var(--c-gray-200);
		border-radius: var(--rad);
		font-family: var(--ff-body);
		font-size: var(--fs-body);
		color: var(--c-ink);
		background: white;
		transition: var(--transition);
	}
	
	.form-group input::placeholder,
	.form-group textarea::placeholder {
		color: var(--c-gray-500);
	}
	
	.form-group input:focus,
	.form-group textarea:focus {
		outline: none;
		border-color: var(--c-primary);
		box-shadow: 0 0 0 3px rgba(0, 160, 151, 0.1);
	}
	
	.form-group textarea {
		resize: vertical;
		min-height: 120px;
	}
	
	.form-footer {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-top: 1.5rem;
		gap: 1rem;
	}
	
	.form-checkbox {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		flex: 1;
	}
	
	.form-checkbox input[type="checkbox"] {
		width: 18px;
		height: 18px;
		cursor: pointer;
		flex-shrink: 0;
	}
	
	.form-checkbox label {
		font-size: var(--fs-body);
		color: var(--c-gray-700);
		margin: 0;
		cursor: pointer;
		line-height: 1.4;
	}
	
	.form-checkbox label a {
		color: var(--c-primary);
		text-decoration: none;
		transition: var(--transition);
	}
	
	.form-checkbox label a:hover {
		color: var(--color-primary-dark);
		text-decoration: underline;
	}
	
	.btn-submit {
		background: var(--c-primary);
		color: white;
		border: none;
		border-radius: var(--rad);
		padding: 0.85rem 2.5rem;
		font-family: var(--ff-body);
		font-size: var(--fs-body);
		font-weight: 600;
		cursor: pointer;
		transition: var(--transition);
		text-transform: uppercase;
		letter-spacing: 0.5px;
	}
	
	.btn-submit:hover {
		background: var(--color-primary-dark);
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(0, 160, 151, 0.3);
	}
	
	.legal-info {
		margin-top: 1rem;
	}
	
	.legal-toggle {
		font-size: var(--fs-small);
		color: var(--c-gray-700);
		text-decoration: none;
		background: none;
		border: none;
		cursor: pointer;
		padding: 0;
		font-family: var(--ff-body);
		transition: var(--transition);
		display: flex;
		align-items: center;
		gap: 0.25rem;
	}
	
	.legal-toggle:hover {
		color: var(--c-primary);
	}
	
	.toggle-icon {
		display: inline-block;
		transition: transform 0.3s ease;
	}
	
	.legal-toggle[aria-expanded="true"] .toggle-icon {
		transform: rotate(180deg);
	}
	
	.legal-content {
		margin-top: 1rem;
		padding: 1.25rem;
		background: #f7f9fa;
		border-radius: var(--rad);
		border-left: 3px solid var(--c-primary);
		font-size: var(--fs-small);
		line-height: 1.6;
	}
	
	.legal-content p {
		margin-bottom: 0.75rem;
		color: var(--c-gray-700);
	}
	
	.legal-content p:last-child {
		margin-bottom: 0;
	}
	
	.legal-content strong {
		color: var(--c-ink);
		font-weight: 600;
	}
	
	.legal-content a {
		color: var(--c-primary);
		text-decoration: none;
		transition: var(--transition);
	}
	
	.legal-content a:hover {
		color: var(--color-primary-dark);
		text-decoration: underline;
	}
	
	.form-message {
		margin-top: 1rem;
		padding: 1rem 1.25rem;
		border-radius: var(--rad);
		font-size: var(--fs-body);
		line-height: 1.5;
		animation: slideDown 0.3s ease-out;
	}
	
	.form-message.success {
		background: #d4edda;
		color: #155724;
		border: 1px solid #c3e6cb;
	}
	
	.form-message.error {
		background: #f8d7da;
		color: #721c24;
		border: 1px solid #f5c6cb;
	}
	
	.form-message.warning {
		background: #fff3cd;
		color: #856404;
		border: 1px solid #ffeeba;
	}
	
	@keyframes slideDown {
		from {
			opacity: 0;
			transform: translateY(-10px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}
	
	.btn-submit:disabled {
		opacity: 0.6;
		cursor: not-allowed;
		transform: none !important;
	}
	
	@media (max-width: 768px) {
		.contact .section-header h2 {
			font-size: 32px;
		}
		
		.contact-background::after {
			background: linear-gradient(
				to bottom,
				rgba(255, 255, 255, 0.3) 0%,
				rgba(255, 255, 255, 0.8) 30%,
				rgba(255, 255, 255, 1) 50%,
				rgba(255, 255, 255, 1) 100%
			);
		}
		
		.contact-form-wrapper {
			justify-content: center;
		}
		
		.contact-form {
			padding: 1.5rem;
		}
		
		.form-row {
			grid-template-columns: 1fr;
		}
		
		.form-footer {
			flex-direction: column;
			align-items: flex-start;
		}
		
		.btn-submit {
			width: 100%;
		}
	}
</style>

<script>
	class LegalToggle {
		private button: HTMLButtonElement;
		private content: HTMLElement | null = null;
		
		constructor(button: HTMLButtonElement) {
			this.button = button;
			const contentId = button.getAttribute('aria-controls');
			const content = contentId ? document.getElementById(contentId) : null;
			
			if (!content) {
				console.warn('No se encontró el contenido legal');
				return;
			}
			
			this.content = content;
			this.button.addEventListener('click', () => this.toggle());
		}
		
		toggle() {
			if (!this.content) return;
			
			const isExpanded = this.button.getAttribute('aria-expanded') === 'true';
			
			if (isExpanded) {
				this.button.setAttribute('aria-expanded', 'false');
				this.content.hidden = true;
			} else {
				this.button.setAttribute('aria-expanded', 'true');
				this.content.hidden = false;
			}
		}
	}
	
	// Inicializar cuando el DOM esté listo
	const initLegalToggle = () => {
		const button = document.querySelector('.legal-toggle') as HTMLButtonElement;
		if (button) {
			new LegalToggle(button);
		}
	};
	
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initLegalToggle);
	} else {
		initLegalToggle();
	}

	// EmailJS Configuration
	// Las credenciales se cargan desde variables de entorno (.env)
	// Para desarrollo local, crea un archivo .env con las variables PUBLIC_EMAILJS_*
	// Para producción en GitHub Pages, configura los secrets en GitHub Actions
	
	const EMAILJS_PUBLIC_KEY = import.meta.env.PUBLIC_EMAILJS_PUBLIC_KEY || '';
	const EMAILJS_SERVICE_ID = import.meta.env.PUBLIC_EMAILJS_SERVICE_ID || '';
	const EMAILJS_TEMPLATE_ID = import.meta.env.PUBLIC_EMAILJS_TEMPLATE_ID || '';
	const RECIPIENT_EMAIL = import.meta.env.PUBLIC_EMAILJS_RECIPIENT_EMAIL || 'admin@clinicaborras.es';

	// Cargar EmailJS desde CDN
	const loadEmailJS = () => {
		return new Promise((resolve, reject) => {
			if (window.emailjs) {
				resolve(window.emailjs);
				return;
			}
			
			const script = document.createElement('script');
			script.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js';
			script.onload = () => {
				window.emailjs.init(EMAILJS_PUBLIC_KEY);
				resolve(window.emailjs);
			};
			script.onerror = reject;
			document.head.appendChild(script);
		});
	};

	// Función para mostrar mensajes
	const showMessage = (message: string, type: 'success' | 'error' | 'warning') => {
		const messageEl = document.getElementById('form-message');
		if (!messageEl) return;
		
		messageEl.textContent = message;
		messageEl.className = `form-message ${type}`;
		messageEl.style.display = 'block';
		
		// Auto-ocultar después de 5 segundos (excepto errores)
		if (type !== 'error') {
			setTimeout(() => {
				messageEl.style.display = 'none';
			}, 5000);
		}
		
		// Scroll suave al mensaje
		messageEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
	};

	// Manejar el envío del formulario
	const handleFormSubmit = async (e: Event) => {
		e.preventDefault();
		
		const form = e.target as HTMLFormElement;
		const submitButton = form.querySelector('.btn-submit') as HTMLButtonElement;
		const originalText = submitButton.textContent;
		const messageEl = document.getElementById('form-message');
		
		// Ocultar mensajes anteriores
		if (messageEl) {
			messageEl.style.display = 'none';
		}
		
		// Validar que las credenciales estén configuradas
		const hasDefaultValues = EMAILJS_PUBLIC_KEY.includes('YOUR_') || 
		                        EMAILJS_SERVICE_ID.includes('YOUR_') || 
		                        EMAILJS_TEMPLATE_ID.includes('YOUR_');
		
		if (!EMAILJS_PUBLIC_KEY || !EMAILJS_SERVICE_ID || !EMAILJS_TEMPLATE_ID || hasDefaultValues) {
			showMessage('⚠️ Error: El formulario no está configurado. Por favor, contacta al administrador.', 'error');
			console.error('EmailJS no está configurado. Por favor, configura las credenciales en ContactSection.astro');
			return;
		}

		// Deshabilitar el botón durante el envío
		submitButton.disabled = true;
		submitButton.textContent = 'ENVIANDO...';

		try {
			// Cargar EmailJS si no está cargado
			await loadEmailJS();

			// Obtener los datos del formulario
			const formData = new FormData(form);
			const nombre = formData.get('nombre') as string;
			const apellido = formData.get('apellido') as string;
			const email = formData.get('email') as string;
			const telefono = formData.get('telefono') as string;
			const mensaje = formData.get('mensaje') as string || 'Sin mensaje';

			// Enviar el email usando EmailJS
			await window.emailjs.send(
				EMAILJS_SERVICE_ID,
				EMAILJS_TEMPLATE_ID,
				{
					to_email: RECIPIENT_EMAIL,
					from_name: `${nombre} ${apellido}`,
					from_email: email,
					phone: telefono,
					message: mensaje,
					subject: `Nuevo contacto de ${nombre} ${apellido}`,
					reply_to: email
				}
			);

			// Mostrar mensaje de éxito
			showMessage('✅ ¡Mensaje enviado correctamente! Te responderemos pronto.', 'success');
			form.reset();

		} catch (error) {
			console.error('Error al enviar el formulario:', error);
			showMessage('❌ Error al enviar el mensaje. Por favor, intenta de nuevo o contacta por teléfono: 948 172 617', 'error');
		} finally {
			// Restaurar el botón
			submitButton.disabled = false;
			submitButton.textContent = originalText;
		}
	};

	// Inicializar el manejo del formulario
	const initContactForm = () => {
		const form = document.getElementById('contact-form') as HTMLFormElement;
		if (form) {
			form.addEventListener('submit', handleFormSubmit);
		}
	};

	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initContactForm);
	} else {
		initContactForm();
	}
</script>
